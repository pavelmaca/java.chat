\documentclass[a4]{article}
\usepackage{xltxtra,polyglossia} 
\setdefaultlanguage{czech} 
\usepackage[]{graphicx}
\usepackage{listings}
\usepackage{color}
\usepackage{blindtext}
\usepackage{scrextend}
\usepackage{hyperref}
\addtokomafont{labelinglabel}{\sffamily}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\footnotesize,
    breakatwhitespace=false,
    breaklines=true,
    captionpos=b,
    keepspaces=true,
    numbers=left,
    numbersep=5pt,
    showspaces=false,
    showstringspaces=false,
    showtabs=false,
    tabsize=2
}

\lstset{style=mystyle}

\title{UAI/685 Chat server - klient}
\author{Pavel Máca}

\begin{document}
\begin{titlepage}
	\centering
	{\Huge Objektové programování v Javì 2\par}
	\vspace{1cm}
	{\Large Zimní semestr 2016/17\par}
	\vspace{1.5cm}
	{\huge\bfseries Chat server - klient\par}
	\vspace{2cm}
	{\Large Pavel Máca\par}
	\vfill

	{\large Projekt by vypracován samostatnì za pomoci zdrojù popsanıch níe.\par}
	{\large \today\par}
\end{titlepage}

\pagebreak

\section{Zadání projektu}
Komunikaèní klient pøipojitelnı na specifické rozhraní, které umoòuje komunikaci mezi ostatními klienty. Server a klienti budou poskytovat mono vytváøení tzv. chatovacích místností.

Forma komunikace bude textová.

Základní rozhraní bude tvoøit nabídka dostupnıch chatovacích místností a okno s aktuálnì otevøenou místností a zprávami.

Pokud nìkterı uivatel odešle zprávu do stejné místnosti, zobrazí se ostatním uivatelùm, kteøí jsou pøipojeni v dané místnosti.
Pokud uivatel obdrí zprávu v jiné místnosti, zobrazí se poèet nepøeètenıch zpráv k dané místnosti v seznamu všech místností.

Uivatel bude vstupovat do místnosti, tím e zaène naslouchat její komunikaci.

Online i offline komunikace. Pokud klient nebude online, zprávy pro nìj se mu zobrazí po pøihlášení.

Systém ukáe klientovi, kdo je aktuálnì online, pokud se nìkdo pøihlásí/odhlásí, všichni klienti na to budou ihned reagovat

Skupiny budou definovány obecnì, uivatel bude moci byt ve vice skupinách, GUI bude mít funkcionalitu, pomoci které se uivatel bude moci sám pøihlašovat a odhlasovat ze skupin

Klient i server v javì.

Projekt bude vyuívat síové programování a vláknové programování pøi naslouchání na více chatovacích místnostech a databázi.

\section{Analıza funkcionality a øešení}
\subsection{Funkcionalita}

Projekt obsahuje jak serverovou èást, tak klienta. Komunikace probíhá na úrovni TCP socketù. Kadı klient se pøipojuje na server, pomocí nastavené IP adresy a portu.

\subsection{Server}

Aplikace bez grafického rozhraní, pouze konzolovı vstup a vıstup. Po spuštìní lze nastavit èíslo portu pro naslouchání novıch klientù. Pøi prvním spuštìní se vyplní pøístupové údaje k databázi.

Kadı pøipojenı klient vytvoøí samostatné vlákno, které má za úkol pøíjem veškeré komunikace od daného klienta. Pokud klient vytvoøí novou místnost, tato místnost bude reprezentována vláknem, rozesílá veškerou komunikaci všem klientùm, kteøí se do místnosti pøipojí. Ve chvíli kdy je místnost prázdná, se vlákno ukonèí. Místnost je však nadále uchována v databázi a do jejího smazání, které mùe provést pouze tvùrce místnosti. Po pøipojení do místnosti, které je prázdná, se opìt spustí vlákno této místnosti.

Uivatel, kterı byl off-line a neopustil místnost, obdrí veškeré zprávy z této doby, jakmile bude opìt online.

Zpráva od klienta je po obdrení zapsána do databáze a následnì odeslána vláknem místnosti všem pøipojenım klientùm.
Ostatní události, jako odchod z místnosti, pøejmenování místnosti apod. jsou také rozesílány všem aktuálnì pøipojenım klientùm.

\subsection{Databáze}

Schéma databáze se nachází v souboru '/sql/install.sql'

Kadı uivatel je reprezentován záznamem v tabulce 'user'. Záznam obsahuje id, která je jedineèné a automaticky generované. Dále pak jméno a heslo.

Místnost je identifikovatelná pomocí èíselného identifikátoru, kterı je jednoznaènı. Kadá místnost má také svého autora, kterı je automaticky administrátorem této místnosti. Po smazání místnosti je tato místnost oznaèena jako smazaná, ale data zùstávají nadále zachována.

Seznam uivatelù v místnosti je reprezentován záznamy v tabulce 'user\_room'.
Seznam blokovanıch uivatelù urèité místnosti se nachází v tabulce 'user\_block'.

Zpráva obsahuje èas odeslání, odesílatele a místnost, ve které byla odeslána.

\subsection{Klient}

Grafické rozhraní umoòuje nastavit IP adresu a port serveru, ke kterému se klient pøipojí. Tuto volbu lze uloit.
Po pøipojení na server se uivatel pøihlásí svou pøezdívkou a heslem.
Pokud uivatel neexistuje, automaticky se vytvoøí záznam na serveru.

Pøihlášenému uivateli se zobrazí seznam všech místností, ve kterıch je pøipojen. Dále má monost pøipojit se do ji existujících místností, nebo vytvoøit novou. Místnost lze chránit heslem a vytvoøit ji tak soukromou pro specifické uivatele.

U kadé místnosti je zobrazen seznam online / pøipojenıch uivatelù. 
Tvùrce místnosti má monost zmìnit název, nastavit heslo a vylouèit (zablokovat) ostatní uivatele z místnosti.

Nastavení klienta (server IP a port) se ukládají do lokálního souboru.

Uivatel má monost se odhlásit, èi odpojit od serveru.

\subsection{Komunikace klient-server}

Komunikaci na stranì klienta obstarává jedno vlákno.

Mezi server a klientem se posílají objekty typu 'Request' a 'Response', kterı se podle parametru dále zpracovávají.
Data formát dat pro komunikaci je specifikován modely v 'pavelmaca.chat.share.model'.

Klient po vytvoøení TCP spojení odešle 'Hand-shake' request, na kterı server odpovídá 'Response.OK'.
Následnì klient odesílá autorizaèní poadavek, na kterı server odpovídá Response, která obsahuje informace o pøihlášeném uivateli.
Po obdrení identity klient posílá poadavek celkovı status uivatele. Server odpovídá seznamem místností, stavy jednotlivıch uivatelù a historií zpráv. Tím se souèasnì klient pøipojí do všech místností pro odbìr dalších zpráv.

Stavové informace odesílá server z RoomThread vlákna pomocí objektu Request s vyplnìnım typem a parametry.
Klient tìmto informacím naslouchá pomocí vlákna Session, které je øadí do blokující fronty, od kud si je pøebírá vlákno GUIRequestListener, které bìí pod EDT a má monost aktualizovat GUI.

Po pøipojení do existující místnosti uivatel obdrí historii pro tuto místnost.

Kadı pøipojenı klient má nastavenı aktuální stav pøipojení. Ten urèuje, které poadavky mùe server od klienta pøijímat. Napøíklad nepøihlášenı klient nemùe odesílat nové zprávy.


\section{Diagramy tøíd}
\subsection{Server}
\scalebox{0.6}{\includegraphics{diagram_server.PNG}}

\subsection{Klient}
\scalebox{0.35}{\includegraphics{diagram_klient.PNG}}

\subsection{Server a klient spoleènì}
\scalebox{0.25}{\includegraphics{diagram_vse.PNG}}

\section{Zhodnocení vısledku}
Vıslednı projekt splòuje zadání a vıraznì se nijak neliší od pùvodní analızy. Aplikace umoòuje rozšiøitelnost o další funkcionalitu díky univerzální implementaci poadavkù a odpovìdí.
Napojení na databázi by mohlo bıt øešeno pomocí ORM (napø. \href{http://hibernate.org/orm/}{Hibernate}), nicménì to nebylo souèástí pøedmìtu a proto bylo zvoleno hybridní øešení s pouitím JDBC API.

Díky pouití blokující fronty na obou stranách komunikace jsou zprávy pøijímány a odesílány synchronnì.

Celı projekt je publikován na adrese \href{https://github.com/pavelmaca/jcu-java-chat}{github.com/pavelmaca/jcu-java-chat}

\section{Pouité zdroje}
\begin{itemize} 
	\item{Prezentace a vıukové materiály k pøedmìtu "Objektové programování II - UAI/685"}
    \item{Dokumentace Javy 8 od Oracle - \href{https://docs.oracle.com/javase/8}{docs.oracle.com/javase/8}}
	\item{Diskuzní fórum stackoverflow.com}
\end{itemize}

\end{document}
